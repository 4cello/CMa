<!DOCTYPE html>
<html lang="en">
  <head>
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
	
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> 
 	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
 	
 	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css" />
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-modal/2.2.6/js/bootstrap-modalmanager.min.js"></script>
 	<style>

 	</style>
 	
  </head>

<body>
    
<div class="container" >

	<div class="container" style="padding:15px;">
		<div class="row">
	    	<div class="col-md-4">
	    		<h1>CMa Virtual Machine</h1>
	    	</div>
	    	
	    	<div class="col-md-6">
	    		<div class="btn-group">
					<form class="form-inline" style="padding:15px">
					
						<label class="mr-sm-2" for="sizeMainMemory">Main Memory</label>
		  				<input type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="sizeMainMemory" placeholder="64" style="width:60px">
	
						<label class="mr-sm-2" for="sizeStack">Stack View</label>
		  				<input type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="sizeStackView" placeholder="32" style="width:60px">
	
					  	<button type="submit" class="btn btn-primary" onclick="createVM()">Re-Create VM</button>
			    		
					</form>
				</div>
	    	</div>
	    	<div class="col-md-2">
	    	
				<div class="dropdown">
					<button type="button" class="btn btn-default dropdown-toggle" id="loadSample" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					 	<span class="glyphicon glyphicon-open-file"></span>Load Sample <span class="caret"></span>
								
					</button>
					<ul class="dropdown-menu" >
						  <li><a href="#" onclick="loadSample('simple.cma')">Simple</a></li>
						  <li><a href="#" onclick="loadSample('sampleFcnCall.cma')">Sample Function Call</a></li>
						  <li><a href="#" onclick="loadSample('factorial.cma')">Recursive Function</a></li>
					</ul>				
				</div>
	    	
	    	</div>
	 	</div>
	</div>
    
    
    
<div class="container">

<!-- Modal Dialog for Program Upload -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
              <button class="close" data-dismiss="modal">×</button>
              <h3>CMa Program Editor</h3>
            </div>
            <div class="modal-body">
	            <div class="row">
	            <div class="col-md-8">
	               <div class="form-group">
				    <label for="exampleTextarea">Code</label>
				    <textarea class="form-control" id="programCode" rows="10" style="font-family:monospace;"></textarea>
				    <a class="btn btn-primary" onclick="parseCode()">Parse program</a>
				  </div>
	            </div>
	             
				  <div class="col-md-4">
				  	<table class="table table-fixed header-fixed "  id="UploadedProgram">
					  <thead >
					  		<th data-field="label">label</th>
						    <th data-field="instruction">instruction</th>
					  </thead>
					</table>
				  
				  </div>
	            </div>

	            <div class="row">
	            <div class="col-md-8">
	            
	            	<div class="alert alert-danger collapse" role="alert" id="ParseError">
	            	<button type="button" class="close" data-dismiss="alert" aria-label="Close">
					    <span aria-hidden="true">&times;</span>
					</button>
					</div>
	            
	            </div>
	            </div>
	        </div>
            <div class="modal-footer">
                <a href="#" class="btn" data-dismiss="modal">Close</a>
            	<a class="btn btn-primary" onclick="loadProgram()">Load program</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dialog for Instruction Description -->
<div class="modal fade" id="instrDescrModal" tabindex="-1" role="dialog" aria-labelledby="myInstrDescrModal" aria-hidden="true">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
              <button class="close" data-dismiss="modal">×</button>
              <h3>Instruction Description</h3>
            </div>
            <div class="modal-body">
            	<div class="panel panel-default" style="margin-top: 10px;">
		            	<div class="panel-heading" >
							<h3 class="panel-title" id="InsructionDescriptionTitle"></h3>
						</div>
					  <div class="panel-body" id="InstructionDescription">
					  </div>
				</div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn" data-dismiss="modal">Close</a>
            </div>
        </div>
    </div>
</div>

</div>

    
    <div class="row">
	    <div class="col-md-3">
		    <div class="panel panel-info" >
		    	<div class="panel-heading" >
					<h3 class="panel-title">Registers</h3>
				</div>
				<div class="panel-body" >
					<table class="table table-bordered" >
						<thead>
							<th>PC</th>
							<th>FP</th>
							<th>SP</th>
							<th>EP</th>
							<th>HP</th>
						</thead>
						<tbody>
							<tr>
								<td id="PC"></td>
								<td id="FP"></td>
								<td id="SP"></td>
								<td id="EP"></td>
								<td id="HP"></td>
							</tr>
						</tbody>
					</table>
					<div class="alert alert-danger collapse" role="alert" id="VMError">
	            	<button type="button" class="close" data-dismiss="alert" aria-label="Close">
					    <span aria-hidden="true">&times;</span>
					</button>
  					<strong>VM Error!</strong> Change a few things up and try submitting again.
					</div>
				</div>
		    </div>
	    </div>
	    <div class="col-md-9">
		    <div class="panel panel-primary" >
		    	<div class="panel-heading" >
					<h3 class="panel-title">Controls</h3>
				</div>
				<div class="panel-body" >
					
						<button type="button" class="btn btn-default" onclick="executeNext()" id="executeBtn">
							<span class="glyphicon glyphicon-step-forward"></span> Next
						</button>
						<button type="button" class="btn btn-default" onclick="runToBreakpoint()" id="runToBreakBtn">
							<span class="glyphicon glyphicon-fast-forward"></span> Run to Brkpt
						</button>
						<button type="button" class="btn btn-default" onclick="runToEnd()" id="playBtn">
							<span class="glyphicon glyphicon-play"></span> Run 
						</button>
						<button type="button" class="btn btn-default" onclick="restart()">
							<span class="glyphicon glyphicon-refresh"></span> Restart
						</button>
						<button type="button" class="btn btn-default" onclick="editProgram()">
							<span class="glyphicon glyphicon-pencil"></span> Edit 
						</button>
						
					<div class="panel panel-default" style="margin-top: 10px;">
						<div class="panel-heading clearfix" >
							<div class="btn-group pull-right">
						        <a href="#" class="btn btn-default btn-sm" onclick="showImplementation()"><span class="glyphicon glyphicon-file"></span>impl</a>
					  		</div>
					  		<h4 id="NextInstr">Panel header</h4>
					  	</div>
						<div class="panel-body" id="NextInstrDescription" style="min-height: 120px; max-height: 120px;overflow-y: scroll;">
						</div>
					</div>
				
				</div>
		    </div>
	    </div>

    </div>
    
 	<div class="row">
	 	<div class="col-md-6">
	 	
			<div class="panel panel-info" >
				<div class="panel-heading" >
			    	<h3 class="panel-title">Program Store (C)</h3>
			    </div>
			    <div class="panel-body" style="margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
			    	<table class="table" style="border-bottom-style:hidden; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
					  <thead style="border:0px; ">
					  		<th class="col-md-1 text-right"></th>
					  		<th class="col-md-2 text-center">label</th>
						    <th class="col-md-1 text-center">addr</th>
						    <th class="col-md-3 ">instr</th>
						    <th class="col-md-5 ">comment</th>
					  </thead>
					</table>
			  	</div>
			  	<div class="panel-body" style="overflow: auto; height: 600px; padding:0px; ">
					<table class="table table-fixed header-fixed "  id="ProgramStore">
					
					</table>
				</div>
			</div>
		
		</div>
	

	 	<div class="col-md-3">
			<div class="panel panel-success">
				<div class="panel-heading">
			    	<h3 class="panel-title">Stack</h3>
			  	</div>
			  	<div class="panel-body" style="margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
			    	<table class="table" style="border-bottom-style:hidden; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
					  <thead style="border:0px; ">
					  		<th class="col-md-3 text-center">addr</th>
						    <th class="col-md-3 text-center">value</th>
						    <th class="col-md-6 text-center">notes</th>
					  </thead>
					</table>
			  	</div>
				<div class="panel-body" style="overflow: auto; height: 600px; padding:0px">
					<table class="table " id="Stack">
					  
					</table>
				</div>
			
			</div>
		</div>
	

		<div class="col-md-3">
			<div class="panel panel-success">
				<div class="panel-heading">
			    	<h3 class="panel-title">Heap</h3>
			  	</div>
			  	<div class="panel-body" style="margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
			    	<table class="table" style="border-bottom-style:hidden; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom:0;">
						<thead style="border:0px; ">
					  		<th class="col-md-3 text-center">addr</th>
						 	<th class="col-md-3 text-center">val</th>
						    <th class="col-md-6 text-center">notes</th>
				  		</thead>
				  	</table>
			  	</div>
				<div class="panel-body" style="overflow: auto; height: 600px; padding:0px">
					<table class="table" id="Heap">
					</table>
				</div>
			
			</div>
		</div>
		
		<div class="row">
			<div class="col-md-10">
		
				<div class="panel panel-default" >
					<div class="panel-heading">
				    	<h3 class="panel-title">Output</h3>
				  	</div>
					<div class="panel-body" >
						<pre class="table" style="overflow: auto; height:200px;" id="out">
						</pre>
					</div>
				</div>
			</div>
		</div>

	</div>
	
	</div> <!--  outer container -->
	    
	<script src="/js/vm.js"></script>
    <script src="/js/instr_arithmetic.js"></script>
    <script src="/js/instr_comparison.js"></script>
    <script src="/js/instr_controlflow.js"></script>
    <script src="/js/instr_io.js"></script>
    <script src="/js/instr_loadstore.js"></script>
    <script src="/js/instr_heap.js"></script>
	<script src="/js/instr_stack.js"></script>
	<script src="/js/parser.js"></script>
	<script src="/js/starter_program.js"></script>
	
	<script type="text/javascript">	

	var SourceCode="";

	var PROGRAM_SPACE = 64;
	var MAIN_MEMORY = 64;
	var STACK_VIEW = 32;
	var MemoryNotes = [];
	var VM = new VirtualMachine(PROGRAM_SPACE, MAIN_MEMORY, STACK_VIEW);
	//VM.loadProgram( starterProgram.instructions, starter_memory );
	
	function parseCode(){
		$('#ParseError').hide();
		var code = $("#programCode").val();
		var result = parseProgram(code);

		$('#UploadedProgram tr').not(function(){ return !!$(this).has('th').length; }).remove()
		
		if( result.errors.length>0 ) {
			var errStr = "";
			for( vare=0; e<error.length; e++){
				var er = error[e];
				errStr += "\n"+ e;
			}
			$('#ParseError').html(errStr);
			$('#ParseError').show();
		}
		
		$('#UploadedProgram').append(
			    $.map(result.instructions, function (instruction, index) {
			    	return '<tr>' 
			    		+ '<td class="col-md-3 text-right table-bordered ">' + instruction.label + '</td>' 
			    		+ '<td class="col-md-6 text-left table-bordered ">' + instruction.toFormattedString() + '</td>'
			    		+ '</tr>';
		}).join());
		
	}
	
	function openLoadProgramDialog(){
		$('#myModal').modal('show');
	}
	
	function editProgram(){
		$("#programCode").val(SourceCode);
		$('#myModal').modal('show');
	}
	
	function loadProgram(){
		SourceCode = $("#programCode").val();
		var result = parseProgram(SourceCode);
		var instructions = result.instructions;
		VM.loadProgram( instructions );
		$('#myModal').modal('hide');
		updateDisplay();
	}
	
	function loadSample(sourceFile){
		$.ajax({
		       url: '/'+sourceFile,
		       dataType: 'text',
		       success: function(data) {
		    		var SourceCode = data;
		    		var starterProgram = parseProgram(SourceCode);
		    		VM.loadProgram( starterProgram.instructions );
			   		updateDisplay();
		       }
		    });
	}
	
	function createVM(){
		var mm = $('#sizeMainMemory').val();
		var sv = $('#sizeStackView').val();
		if( !isNaN(mm) && mm>0 && mm<1024 ){
			MAIN_MEMORY = mm;
		}
		if( !isNaN(sv) && sv>0 && sv<MAIN_MEMORY ){
			STACK_VIEW = sv;
		} else {
			STACK_VIEW = MAIN_MEMORY / 2;
		}
		VM = new VirtualMachine(PROGRAM_SPACE, MAIN_MEMORY, STACK_VIEW);
		updateDisplay();		
	}
	
	function showImplementation(){
		if( VM.isRunning()  ) {
			var instr = VM.C[VM.PC];
			
			if( instr && instr.def ){
				var def = instr.def;
				if( def.impl ) {
					alert(def.impl);
				}
			}
		}
	}
	
	function executeNext(){
		try{
			VM.executeNextInstruction();
		} catch( err ) {
			$('#VMError').html(err);
			$('#VMError').show();
		}
		updateDisplay();		
	}
	
	function runToEnd(){
		// run until halt or error
		while( VM.isRunning() ) {
			VM.executeNextInstruction();
			updateDisplay();	
		}
	}
	
	function runToBreakpoint(){
		try{
			VM.executeNextInstruction();
		} catch( err ) {
			$('#VMError').html(err);
			$('#VMError').show();
		}
		while( VM.isRunning() && !VM.isNextInstructionBreakpoint() ) {
			try{
				VM.executeNextInstruction();
				updateDisplay();
			} catch( err ) {
				$('#VMError').html(err);
				$('#VMError').show();
			}
			
		};
	}
	
	function updateNextInstructionInformation(instr){
		var def = instr.def;
		if( VM.isRunning() && def ) {
			var info = "";
			if( def.semantics ){
				info += '<p><code>'+def.semantics+'</code></p>';
			}
			
			info += '<p>'+def.description+'</p>';
			
			$('#NextInstr').html('<b><code>'+def.name+'</code></b>');
			$('#NextInstrDescription').html(info);
		} else {
			$('#NextInstr').html('');
			$('#NextInstrDescription').html('');
		}
	}

	function updateDisplay(){
		
		if( $('#PC').text() != VM.PC ) {
			$('#PC').html('<b>'+VM.PC+'</b>');
		} else {
			$('#PC').html(VM.PC);
		}
		if( $('#FP').text() != VM.FP ) {
			$('#FP').html('<b>'+VM.FP+'</b>');
		} else {
			$('#FP').html(VM.FP);
		}
		if( $('#SP').text() != VM.SP ) {
			$('#SP').html('<b>'+VM.SP+'</b>');
		} else {
			$('#SP').html(VM.SP);
		}
		if( $('#EP').text() != VM.EP ) {
			$('#EP').html('<b>'+VM.EP+'</b>');
		} else {
			$('#EP').html(VM.EP);
		}
		if( $('#HP').text() != VM.HP ) {
			$('#HP').html('<b>'+VM.HP+'</b>');
		} else {
			$('#HP').html(VM.HP);
		}

		var pcData = [];

		for(var i=0; i<VM.C.length; i++) {
			var instr = VM.C[i];
			
			var row = row = { "address": i };
			if( VM.PC == i ) {
				row.ptr = '<span class="glyphicon glyphicon-chevron-right"/>';  
				updateNextInstructionInformation(instr);
			} else {
				row.ptr = "";
			}
			if( instr.breakpoint ) {
				row.ptr += '<span class="glyphicon glyphicon-record"/>'; 
			} 

			row.instruction = instr.toFormattedString();
			
			if( instr.label ) {
				row.label = instr.label+':';
			} else {
				row.label = "";
			}
			
			if( instr.comment ) {
				row.comment = instr.comment;
			} else {
				row.comment = "";
			}
			pcData.push(row);
			
		}
		
		$('#ProgramStore').empty();
		$('#ProgramStore').append(
			    $.map(pcData, function (item, index) {
			    	return '<tr>' 
			    		+ '<td class="col-md-1 text-right" id="bp">' + item.ptr + '</td>' 
			    		+ '<td class="col-md-2 text-right table-bordered ">' + item.label + '</td>' 
			    		+ '<td class="col-md-1 text-center table-bordered ">' + index + '</td>'
			    		+ '<td class="col-md-3 text-left table-bordered " id="instr">' + item.instruction + '</td>'
			    		+ '<td class="col-md-5 text-left table-bordered " style="text-color: green"><i>' + item.comment + '</i></td>'
			    		+ '</tr>';
		}).join());
		
		
		var stackData = [];

		for(var i=VM.MAX_STACK_SIZE-1; i>=0; i--) {
			
			var value = VM.S[i];
			
			var row = { "address": i };
			row.value = value.toString();
			
			row.color = '#c4daef';
	    	if( i > VM.SP ){
	    		row.color = "#ffffff";
	    		row.value = "<i>" + value.toString() + "</i>";
	    	}
	    	if( MemoryNotes[i] ){
		    	row.note = MemoryNotes[i];
	    	} else {
		    	row.note = "";
	    	}
			stackData.push(row);
		}
		
		$('#Stack').empty();
		$('#Stack').append(
			    $.map(stackData, function (item, index) {
			    	return '<tr>'
			    		+ '<td class="col-md-3 text-right table-bordered" style="background-color:'+ item.color +'">' + item.address + '</td>' 
			    		+ '<td class="col-md-3 text-center table-bordered" style="background-color:'+ item.color +'">' + item.value + '</td>'
			    		+ '<td class="col-md-6 text-left table-bordered" style="background-color:'+ item.color +'" id="note">'+item.note+'</td>'
			    		+ '</tr>';
			}).join());


		var heapData = [];

		for(var i=VM.MAIN_MEMORY_SIZE-1; i>=VM.EP; i--) {
			var heapValue = VM.S[i];
			var addr = i ;
			var row = { "address": addr};
			row.value = heapValue.toString();
			
			row.color = "#ffffff";
	    	if( addr >= VM.HP ){
	    		row.color = '#efe9c4' ;
	    	}
	    	if( MemoryNotes[i] ){
		    	row.note = MemoryNotes[i];
	    	} else {
		    	row.note = "";
	    	}
			heapData.push(row);
		}
		
		$('#Heap').empty();
		$('#Heap').append(
			    $.map(heapData, function (item, index) {
			    	return '<tr>' 
			    		+ '<td class="col-md-3 text-center table-bordered" style="background-color:'+ item.color +'">' + item.address + '</td>'  
			    		+ '<td class="col-md-3 text-center table-bordered" style="background-color:'+ item.color +'">' + item.value + '</td>'
			    		+ '<td class="col-md-6 text-left table-bordered" style="background-color:'+ item.color +'" id="note">'+item.note+'</td>'
			    		+ '</tr>';
		}).join());
		
		var output = VM.eatOutput();
		$("#out").append(output);
		
		if( !VM.isRunning()) {			
			$('#NextInstr').html("<code></code>"); // keep code element to prevent the bar from resizing
			$('#NextInstrDescription').html("");
		}
		
		$('#executeBtn').prop('disabled', !VM.isRunning());
		$('#playBtn').prop('disabled', !VM.isRunning());
		$('#runToBreakBtn').prop('disabled', !VM.isRunning());
			
		$('#ProgramStore tr td#bp').click(function(e){
			  toggleBreakpoint(this);
		});
		$('#ProgramStore tr td#instr').click(function(e){
			displayInstructionDescription(this);
		});
		
		$('#Stack tr td#note').click(function(e){
			var address = $(this).closest('tr').find('td:eq(0)').text();
			var oldNote = "";
			if( MemoryNotes.length>address && MemoryNotes[address]){
				oldNote =  MemoryNotes[address];
			}
 			var note = prompt('Note', oldNote);
			MemoryNotes[address]=note;
			$(this).closest('tr').find('td:eq(2)').text(note);
		});
	}
	
	
	function restart(){
		VM.restart();
		$("#out").html("");
		$('#VMError').hide();
		updateDisplay();
	}
	
	function toggleBreakpoint(td){
		
		var address = $(td).closest('tr').find('td:eq(2)').text();
		
		var instr = VM.C[address];
		
		var html = "";
		if( VM.PC == address ){
			html = '<span class="glyphicon glyphicon-chevron-right"/>';
		}
		
		if( instr.toggleBreakpoint() ) {
			html += '<span class="glyphicon glyphicon-record"/>';
		} 
		
		$(td).html(html);

	}

	function displayInstructionDescription(td){
		
		var address = $(td).closest('tr').find('td:eq(2)').text();
		
		var instr = VM.C[address];
		var def = instr.def;
		
		var html = '<p><code>'+def.semantics+'</code></p><p>' + def.description + '</p>';
		
		$('#InstructionDescription').html(html);
		$('#InsructionDescriptionTitle').text(def.displayName);
		
		$('#instrDescrModal').modal('show');
	}


	
	$( document ).ready(function() {
		updateDisplay();
		$("#out").html("");
		$('#sizeProgramSpace').val(PROGRAM_SPACE);
		$('#sizeMainMemory').val(MAIN_MEMORY);
		$('#sizeStackView').val(STACK_VIEW);
	});

	</script>


  </body>
</html>


